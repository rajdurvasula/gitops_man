#!groovy

@Library('jenkins-shared-library')

pipeline {
    agent any

    parameters {
        string(name: 'manifest', defaultValue: 'manifest.default.json', description: 'Manifest from Git source')
    }

    stages {
        stage('Get Code') {
            agent {
                label "config_node"
            }
            steps {
                cleanWs()
                checkout scm
            }
        }
        stage('Read Config') {
            agent {
                label "config_node"
            }
            steps {
                deployWithManifest([
                    manifestfile: "${params.manifest}"
                ])
            }
        }
        stage('Launch Infrastructure Pipeline') {
            agent {
                label "config_node"
            }
            steps {
                def manifest = readJSON file: "${params.manifest}"
                def job
                if (manifest.infrastructure.provider == "aws") {
                    if (manifest.infrastructure.endpoint_types[?type == 'rhel']) {
                        job = build job: "aws_rhel_infra_pipeline",
                        parameters: [
                            [$class: 'StringParameterValue', name: 'aws_cred_id', manifest.infrastructure.credentialsId],
                            [$class: 'StringParameterValue', name: 'inst_count', manifest.endpoint_types[type=='rhel'].count],
                            [$class: 'StringParameterValue', name: 'inst_user', manifest.endpoint_types[type=='rhel'].user],
                            [$class: 'StringParameterValue', name: 'ssh_cred_id', manifest.endpoint_types[type=='rhel'].credentialsId],
                            [$class: 'StringParameterValue', name: 'terraform_script', manifest.terraform.rhel.file]
                        ]
                    }
                }
            }
        }
    }
}