pipeline {
    agent any

    parameters {
        string(name: 'manifest', defaultValue: 'manifest.rhel8.json', description: 'Manifest from Git source')
	string(name: 'aws_pipeline', defaultValue: 'Jenkins-pubcloud-aws', description: 'Pipeline project')
    }

    stages {
        stage('Get Code') {
            steps {
                cleanWs()
                checkout([
                    $class: 'GitSCM',
                    branches: [[ name: 'rd_pr2' ]],
                    userRemoteConfigs: [[
                        url: "${SCM_URL}",
                        credentialsId: "rd_git"
                    ]]
		        ])
            }
        }

        stage('Launch Pipeline') {
            steps {
                script {
                    def manifest = readJSON file: "${params.manifest}"
                    def job
                    if (manifest.infrastructure.provider == "aws") {
                        for (def ep_type : manifest.infrastructure.endpoint_types) {
                            if (ep_type.type == 'rhel7') {
                                job = build job: "${params.aws_pipeline}", wait: true, propagate: true,
                                parameters: [
                                    [$class: 'StringParameterValue', name: 'OS_TYPE', value: "${ep_type.os}"],
                                    [$class: 'StringParameterValue', name: 'AMI', value: "${manifest.terraform.aws.rhel7.ami}"],
                                    [$class: 'StringParameterValue', name: 'manifest_file', value: "${params.manifest}"]
                                ]
                            }
                        }
                    }
                }
            }
        }
    }
}
