// Declarative Pipeline this.

def SCM_URL = "https://github.com/rajdurvasula/gitops_man.git"
def SCM_REF = ""
def tfvars_txt = ""

pipeline  {
    agent none

    parameters {
        choice(name: 'OS_TYPE', choices: ['win2016','rhel7','rhel8','sles15'], description: 'Endpoint Operating System')
        string(name: 'TFVARS_FILE', defaultValue: 'input.tfvars', description: 'Terraform Parameters file')
    }

    stages {
        stage("Checkout SCM") {
            agent  {
                label "config_node"
            }
            steps {
                cleanWs()
                
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: 'master']],
                    userRemoteConfigs: [[
                        url: '${SCM_URL}',
                        credentialsId: 'rd_git'
                    ]]
                ])
            }

        }

        stage('Plan') {
            agent  {
                label "config_node"
            }
            steps {
                withCredentials([sshUserPrivateKey(
                    credentialsId: 'rd_ssh',
                    keyFileVariable: 'SSH_KEY'
                )]) {
                    sh "rm -f ${env.WORKSPACE}/rd_ssh_key.pem"
                    sh "cp $SSH_KEY ${env.WORKSPACE}/rd_ssh_key.pem"
                }

                script {
                    tfvars_txt = $tfvars_txt + "Hello World !"
                }
                fileOperations {
                    fileCreateOperation(params.TFVARS_FILE, tfvars_txt)
                }
            }
        }       
    }
}